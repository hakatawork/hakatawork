<script>
    // ... (tidigare kod för initiering och elementhantering)

    async function searchRestaurants(isRandom) {
        try {
            elements.loading.style.display = 'block';
            elements.resultsContent.innerHTML = '';
            
            const [originLat, originLng] = elements.area.value.split(',').map(Number);
            const radius = parseInt(elements.radius.value);
            const minRating = parseFloat(elements.minRating.value);
            const maxPrice = parseInt(elements.maxPrice.value);
            
            let restaurants = [];
            const apiKey = getApiKeyFromCookie();
            
            // Försök hämta riktig data om API-nyckel finns
            if (apiKey && window.google && window.google.maps && window.google.maps.places) {
                const basicResults = await getRealRestaurants(originLat, originLng, radius);
                
                // Hämta fullständiga detaljer för varje restaurang
                restaurants = await Promise.all(
                    basicResults.map(async (place) => {
                        try {
                            const details = await getPlaceDetails(place.place_id);
                            return {
                                ...place,
                                ...details,
                                website: details.website || place.website,
                                photoUrl: details.photoUrl || place.photoUrl
                            };
                        } catch (e) {
                            console.error('Error fetching details:', e);
                            return place;
                        }
                    })
                );
                
                // Beräkna avstånd för varje restaurang
                restaurants.forEach(restaurant => {
                    if (restaurant.geometry && restaurant.geometry.location) {
                        const destLat = restaurant.geometry.location.lat();
                        const destLng = restaurant.geometry.location.lng();
                        restaurant.distance = calculateDistance(originLat, originLng, destLat, destLng);
                    }
                });
            } else if (!apiKey) {
                showError('Ingen API-nyckel hittades. Visar exempeldata.');
            } else {
                throw new Error('Google Maps API inte tillgängligt');
            }
            
            // Om ingen riktig data hittades, använd mockdata
            if (restaurants.length === 0) {
                throw new Error('Inga restauranger hittades via API');
            }
            
            // Filtrera resultat
            const filtered = restaurants.filter(place => {
                const ratingOk = !place.rating || place.rating >= minRating;
                const priceOk = !place.price_level || place.price_level <= maxPrice;
                return ratingOk && priceOk;
            });
            
            if (isRandom && filtered.length > 0) {
                const randomIndex = Math.floor(Math.random() * filtered.length);
                displayRestaurants([filtered[randomIndex]], true, originLat, originLng);
            } else {
                displayRestaurants(filtered, false, originLat, originLng);
            }
        } catch (error) {
            console.error('Error searching restaurants:', error);
            // Fallback till mockdata
            const mockData = getMockRestaurants();
            // Beräkna avstånd för mockdata
            mockData.forEach(restaurant => {
                restaurant.distance = 0.1 + Math.random() * 1.4;
            });
            displayRestaurants(mockData, isRandom, originLat, originLng);
            if (!getApiKeyFromCookie()) {
                elements.apiKeyForm.style.display = 'block';
            }
        } finally {
            elements.loading.style.display = 'none';
        }
    }

    // ... (resten av din befintliga kod)
</script>
